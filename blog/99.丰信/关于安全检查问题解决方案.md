# 关于安全检查问题解决方案

## 1. 对单位时间内请求访问数量进行限制（限流操作）

#### 定位问题： 

+ 所有系统

#### 解决问题： 

+ [springmvc限流解决方案](https://blog.csdn.net/u013305864/article/details/93804959)
+ 使用AOP或前置拦截器/过滤器实现上述方案，尽量不入侵源程序。


## 2. 对用户登录错误密码次数做限制

#### 定位问题： 

+ 除CRM以外所有系统。 


#### 解决问题： 

+ 如在单位时间内密码超过5次，就锁定当前用户1小时内禁止登录，1小时后可再次重试，如果还是重试失败，锁定增加1天，以此类推，防止密码被暴力破解。
 
+ 可以使用Redis数据库来保存当前用户的登录次数。也就是执行认证方法doGetAuthenticationInfo的次数，
+ 如果登录成功就清空计数，登录失败返回相应的错误信息
+ 使用redis的string.increment(key, 1 )



## 3. 对登录增加验证码验证

#### 定位问题： 

+ 除CRM以外所有系统。但CRM系统需要升级验证码程序 


#### 解决问题： 

+ 1. [可以通过这个工具：自定义数字字母验证码，加减乘除验证码等。](https://www.hutool.cn/docs/#/captcha/%E6%A6%82%E8%BF%B0) 
+ 2. 提高验证码的验证机制，验证码和用户名密码一起传到后台验证。先进行验证码的验证，通过后再进行用户名密码验证。这样可以避免劫持，绕过验证码直接登录。
+ 3. （备选）倘若验证码错误次数过多，一直未通过。可以自动增加短信验证码的校验。


## 4. 加强密码加密规则

#### 定位问题： 

+ 所有系统（包括app）

#### 解决问题： 

+ 1. 可以改用passwordEncoder加密: 
    + 1). 描述： 
        + 是 Spring Security 推荐的默认密码编码器，
        + 使用哈希算法+随机盐来对字符串加密，哈希是一种不可逆算法，无法通过彩虹表攻击   
        + 最好选择是 SHA-256、BCrypt 加密方式
        + 加密验证代码简单，安全系统高。

  + 2). 加密


    ```java

      passwordEncoder.encode("123456")

    ```

  + 3). 密码验证

      ```java

      passwordEncoder.matches(loginParam.getPassword(), user.getPassword())

      ```
  + 4). 对同一密码加密示例： 
      
      ``` sql 
    
        123456 - $2a$10$mmaOFV2xi49hG/cBegm9fOXJCkCyTHi2Cy/lUdGhQuQcECBj5mHRe
        123456 - $2a$10$e9t/uLJ4HvF2b4dTu9O1E.s4/J1fpQJsyrfIu/F5wfrqlHeBTWS1y
        123456 - $2a$10$sCB84kl5i1bFIwC0HlG8..lbrhunf1GStYQXRFaoMHBGImgWf5TEK
        123456 - $2a$10$FGUG5vhtBwxyaK4/rW6EaOb63DbK7genAUbqCovIryBHdE3b38XaG
        123456 - $2a$10$CVgROl8VBPpSD2jCk105JeDREcpufe5ZJCdpv.mtlsXOtndp6F1ki
        123456 - $2a$10$EAwlnKJlQ.olxf7tZhtEx.QEUvcAVUMqHEYLjYaBPATA9c/KvzaEm

        # 同一字符串加密后显示都不一样。

      ```
+ 2. 对现存用户，修改新的加密规则之后有两种方案。
 
    > 考虑到用户数量之大，37468，让所有人都去登录系统修改密码显然不现实，如未修改密码同样会存在若密码风险。


    + 方案一 ： 后台刷用户数据。

      + 后台统一修改密码为：姓名首字母+身份证后6位(带X的向前顺一位)
      + 需其他部门配合通知各级各级代理商营业厅使用新密码登录，可自行修改密码。
      + 即使未通知到也不会存在弱密码攻击

    + 方案二 ： 不刷数据
  
      + 因修改了密码规则，所有的原密码已失效，弱密码也同样无法登录。
      + 如代理商营业厅需要登录可联系操作员进行重置密码
      + 这里“操作员”需其他部门配合操作





## 5. 对文件上传进行过滤限制


#### 定位问题： 

+ 标准版/邮信通-新增新闻广告
+ 标准版/邮信通-所有导入


#### 解决问题： 

+ 前端和后端进行双重限制上传类型
  
  + 新闻广告类只允许图片类型：JPEG，JPG，PNG
  + 导入只允许excel： xlsx， xls  ， 可以拓展至 csv
  

## 6. 升级fastjson到最新版（fastjson 1.2.76）


#### 定位问题： 

+ 标准版/邮信通 pom.xml

#### 解决问题： 

  + 标准版目前版本：1.2.23
  + 邮信通目前版本：1.2.62
  + 统一升级为1.2.76